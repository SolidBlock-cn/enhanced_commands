# NBT 谓词

**NBT 谓词**（NBT predicate）是用于判断 NBT 的条件。任何 NBT 值都会符合或者不符合某个谓词。

使用 [`/testarg nbt_predicate <NBT 谓词> match <NBT>`](../../commands/testarg/zh.md) 可用于判断 NBT 是否符合指定的谓词。

## 简单值

NBT 谓词可以直接判断任意的 NBT 值。在 NBT 函数中，除了列表和复合标签之外的值，直接表示这个值是都是这种简单的谓词：

- `3s`：当 NBT 值为短整型的 3 时通过。例如，`3s` 符合此谓词，`4s`、`2d` 以及其他类型的值如 `"string"`、`[]` 等均不符合。
- `"str"`：当 NBT 值为字符串 `"str"` 时通过。

简单值的 NBT 谓词前可以加 `:`。例如，`3s` 和 `:3s` 等价。

## 任意值

`*` 可以匹配任意的 NBT 值。`:=` 和 `=*` 是等价的。

## 数值判断

使用 `=` 后接数值可以判断 NBT 是否在数值上等于某个值，而无论其类型。这种谓词仅适用于数字类型的 NBT，其他 NBT 类型均不符合此类谓词。

- `= 3s`：数值上等于 3 时通过。例如，`3s`、`3`、`3d` 均符合此谓词，`4s`、`5` 以及其他类型的值均不符合。
- `= 8.5`：数值上等于 8.5 时通过。例如，`8.5`、`8.5f` 均符合此谓词，`9`、`10s` 以及其他类型的值均不符合。

如果等号后面接的是字符串或数组，那么和简单谓词等价，例如 `= t` 和 `: t` 或 `t` 等价，`= [i;1,2,3]` 和 `: [i;1,2,3]` 或 `[i;1,2,3]` 等价。

> 以这个例子为例，使用 `/testarg` 来判断 NBT 谓词：`/testarg nbt_predicate =3s test 3` 返回 `true`。

## 正则表达式

可以使用正则表达式来判断字符串。其他类型的 NBT 值均不符合此类谓词。

- `~ "^abc"`：当 NBT 为字符串且以 `abc` 开头时通过。`abc`、`abcd`、`abcAABB` 均符合此谓词，`bcd`、`ab`、`2`、`[]` 等均不符合此谓词。
- `~ "[Cc]at"`：当 NBT 为字符串且符合此正则表达式时通过。`cat`、`Cat` 均符合此谓词。

在特定的情况下，引号可以省略，部分字符（包括 `$`、`^`、`*` 等）可以不必加引号，但是如果涉及有空格或括号等字符则必须有引号。如果正则表达式有误，则会解析错误。

## 复合标签

对复合标签的匹配方式有两种，一种是精准匹配，一种是非精准匹配。在精准匹配模式下，不能有任何其他未指定的字段，否则会匹配不通过。以等号开头的是精准匹配：

- `{a: 1}`：当 NBT 值为复合标签且其 `a` 为 1 时通过。复合标签内的其他标签不影响。例如，`{a: 1}`、`{a: 1, b: 2}` 均符合此谓词。
- `= {a: 1}`：当 NBT 值为复合标签且其 `a` 为 1 且没有其他字段时通过。例如，`{a: 1}` 符合此谓词，但是 `{a: 1, b: 2}` 不符合。

对复合标签内的内容也可以使用不同的谓词，例如：

- `{a: >1}`：当复合标签内的 `a` 数值上大于 1 时通过。`{a: 5}`、`{a: 9b}` 均符合此谓词，`{}`、`{a: -1}`、`{a: "str"}` 不符合此谓词。
- `{a ~ "s$"}`：当复合标签内的 `a` 符合此正则表达式时通过。例如，`{a: floats}`、`{a: values, b: other_value}` 均符合此谓词，`{}`、`{a: 1}`、`{a: play}` 不符合此谓词。
- `{a = {x: y}}`：当复合标签内的 `a` 的值为复合标签，且其 `x` 值为 `y` 且无其他字段时通过。例如，`{a: {x: y}, b: other_value}` 符合此谓词，`{a: {x: y, z: w}}` 不符合此谓词。
- `{a !: b}`：当复合标签内的 `a` 值存在且其值不为字符串值 `b` 时通过。
- `{a: *}`：当复合标签内的 `a` 值存在时通过。

需要注意的是，如果使用了否定，仍需要确保该字段存在才通过：

- `{a != *}`：当复合标签内的 `a` 值存在且不为任何时时通过。
- `{a != 3}`：当复合标签内的 `a` 值存在且不在数值上等于 3 或者不是数值时通过。

在非精准匹配中，键可以指定为星号，表示只要有这个值时通过：

- `{*: a}`：当复合标签存在任一字段的值为字符串 `a` 时通过。
- `{* > 3}`：当复合标签内存在任一字段的值为数值且数值上大于 3 时通过。
- `{*: *}`：当复合标签内至少一个值时通过。
- `= {*: b}`：无效的 NBT 谓词，因为精准匹配的谓词不能使用星号键。
- `{"*": a}`：由于使用了引号，这个 NBT 谓词被解析为当复合标签内以星号为名称的字段的值为 `a` 时通过。

目前，精准匹配的 NBT 谓词不允许重复键。

## 列表

对列表的匹配分为精准匹配和非精准匹配。在精准匹配中，列表的长度和各元素都必须匹配才通过，而在非精准匹配中，只要预期的列表中的各个谓词在被测试的列表中都能找到符合该谓词的元素则通过。以等号开头的是精准匹配：

- `[1, 2, 3]`：当 NBT 值为列表，且列表内存在 1、2、3 这三个元素时通过。例如，`[3, 1, 2]`、`[1, 3, 3, 2, 5]` 符合此谓词，`[1, 2]` 和 `{key: value}` 不符合此谓词。该谓词等价于 `[:1, :2, :3]`。
- `=[1, 2, 3]`：当 NBT 值为列表，且列表内有且仅有 3 个元素，且这 3 个元素为 1、2、3 时通过。例如，`[1, 2, 3]`、`[1, 2s, 3b]` 符合此谓词，`[3, 2, 1]`、`[1, 2, 3, 4]` 不符合此谓词。该谓词等价于 `= [=1, =2, =3]`。

非精准匹配的列表中，一个元素可能会被多个谓词匹配：

- `[>3, <5]`：当列表内有大于 3 的元素，且有小于 5 的元素时通过。`[4]` 和 `[1, 8]` 均符合此谓词。
- `[3, 3]`：当列表内有任一元素为整数 3 时通过。`[3]` 符合此谓词。

对于非精准匹配的列表，可以为列表元素指定索引，表示必须是位于该索引的元素存在且符合指定谓词。索引可以是负值，表示从最后一个元素向前数：

- `[a, 1: b]`：当列表内有元素 `a`，且第 2 个元素的值为 `b` 时通过。
- `[0: a, -1: b]`：当列表内的第一个元素为 `a`，且最后一个元素为 `b` 时通过。
- `[5: *]`：当列表内的第 6 个元素存在时通过。